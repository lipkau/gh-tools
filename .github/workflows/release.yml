name: Release Actions

on:
  push:
    tags:
      - '*/v*' # Matches action-name/v1.0.0 pattern
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., changelog-to-release/v1.1.0)'
        required: true

permissions:
  contents: write
  actions: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse tag
        id: parse
        run: |
          # Get tag from push or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${{ github.ref_name }}"
          fi

          # Extract action name and version
          ACTION_NAME=$(echo "$TAG" | cut -d'/' -f1)
          VERSION=$(echo "$TAG" | cut -d'/' -f2)

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "action_name=$ACTION_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "action_path=actions/$ACTION_NAME" >> $GITHUB_OUTPUT

      - name: Verify action exists
        run: |
          if [ ! -d "${{ steps.parse.outputs.action_path }}" ]; then
            echo "Error: Action directory ${{ steps.parse.outputs.action_path }} does not exist"
            exit 1
          fi
          if [ ! -f "${{ steps.parse.outputs.action_path }}/CHANGELOG.md" ]; then
            echo "Error: CHANGELOG.md not found in ${{ steps.parse.outputs.action_path }}"
            exit 1
          fi

      - uses: actions/setup-node@v5
        with:
          node-version-file: .nvmrc

      - run: npm install

      - run: npm run build

      - uses: ./actions/changelog-to-release
        id: release_notes
        with:
          version-name: ${{ steps.parse.outputs.version }}
          changelog: ${{ steps.parse.outputs.action_path }}/CHANGELOG.md

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.parse.outputs.tag }}
          name: '${{ steps.parse.outputs.action_name }} ${{ steps.release_notes.outputs.title }}'
          body: |
            ${{ steps.release_notes.outputs.body }}

            ## üì¶ Usage

            ```yaml
            uses: lipkau/gh-tools/actions/${{ steps.parse.outputs.action_name }}@${{ steps.parse.outputs.tag }}
            ```

            Or use the major version for auto-updates:

            ```yaml
            uses: lipkau/gh-tools/actions/${{ steps.parse.outputs.action_name }}@v1
            ```

            ## üìÅ Action Directory

            [`actions/${{ steps.parse.outputs.action_name }}`](https://github.com/${{ github.repository }}/tree/${{ steps.parse.outputs.tag }}/actions/${{ steps.parse.outputs.action_name }})
          draft: false
          prerelease: false

      - name: Update major version tag
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const version = '${{ steps.parse.outputs.version }}';
            const majorVersion = version.split('.')[0];

            console.log(`Creating/updating major version tag: ${majorVersion}`);

            try {
              // Try to delete existing tag first
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref: `tags/${majorVersion}`
              });
              console.log(`Deleted existing tag: ${majorVersion}`);
            } catch (error) {
              console.log(`Tag ${majorVersion} doesn't exist yet, creating new one`);
            }

            // Create new tag
            await github.rest.git.createRef({
              owner,
              repo,
              ref: `refs/tags/${majorVersion}`,
              sha: context.sha
            });

            console.log(`Successfully created/updated tag: ${majorVersion}`);
